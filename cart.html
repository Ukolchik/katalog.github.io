<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–æ—Ä–∑–∏–Ω–∞</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <h1>–ö–æ—Ä–∑–∏–Ω–∞</h1>
  <a href="index.html" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
</header>

<main class="cart-container">
  <h2>–í–∞—à–∏ —Ç–æ–≤–∞—Ä—ã</h2>
  <table id="cart-table">
    <thead>
      <tr>
        <th>–¢–æ–≤–∞—Ä</th>
        <th>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</th>
        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- üî• –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ -->
  <button id="clear-cart" class="btn-clear">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>

  <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
  <form id="order-form">
    <div class="form-group">
      <label for="name">–ò–º—è</label>
      <input type="text" id="name" required>
    </div>
    <div class="form-group">
      <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
      <input type="tel" id="phone" required>
    </div>
    <div class="form-group">
      <label for="email">E-mail</label>
      <input type="email" id="email" required>
    </div>
    <button type="submit" class="btn-submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
  </form>
</main>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  const SERVICE_ID = "service_j4uw3iu";
  const TEMPLATE_ID = "template_966t464";
  const PUBLIC_KEY = "dcPnlrnIbilT3UWlS";

  emailjs.init(PUBLIC_KEY);

  let cart = JSON.parse(localStorage.getItem("cart")) || [];
  const cartTableBody = document.querySelector("#cart-table tbody");

  const chainLengths = [40,45,50,55,60,65,70];

  function renderCart() {
    cartTableBody.innerHTML = "";
    if(cart.length === 0){
      cartTableBody.innerHTML = `<tr><td colspan="3">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</td></tr>`;
      return;
    }

    cart.forEach((item, index) => {
      const row = document.createElement("tr");

      // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ü–µ–ø–µ–π
      let paramsHtml = '';
      if(item.type === 'chain') {
        const lengthSelect = `<select data-index="${index}" class="length-select">${chainLengths.map(l=>`<option value="${l}" ${l===item.length?'selected':''}>${l}</option>`).join('')}</select>`;
        const widthSelect = `<select data-index="${index}" class="width-select">${item.availableWidths.map(w=>`<option value="${w}" ${w===item.width?'selected':''}>${w}</option>`).join('')}</select>`;
        paramsHtml = `–î–ª–∏–Ω–∞: ${lengthSelect} –º–º, –®–∏—Ä–∏–Ω–∞: ${widthSelect} –º–º`;
      } else {
        paramsHtml = '-';
      }

      row.innerHTML = `
        <td>${item.name}</td>
        <td>${paramsHtml}</td>
        <td><input type="number" min="1" value="${item.qty}" data-index="${index}"></td>
      `;
      cartTableBody.appendChild(row);
    });

    // –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    document.querySelectorAll("#cart-table input[type='number']").forEach(input=>{
      input.addEventListener("change", e=>{
        const idx = e.target.dataset.index;
        cart[idx].qty = parseInt(e.target.value) || 1;
        saveCart();
      });
    });

    // –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª–∏–Ω—ã/—à–∏—Ä–∏–Ω—ã
    document.querySelectorAll(".length-select").forEach(select=>{
      select.addEventListener("change", e=>{
        const idx = e.target.dataset.index;
        cart[idx].length = parseInt(e.target.value);
        saveCart();
      });
    });
    document.querySelectorAll(".width-select").forEach(select=>{
      select.addEventListener("change", e=>{
        const idx = e.target.dataset.index;
        cart[idx].width = parseFloat(e.target.value);
        saveCart();
      });
    });
  }

  function saveCart() {
    localStorage.setItem("cart", JSON.stringify(cart));
  }

  // üî• –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ ¬´–≤ —Å—Ç–æ–ª–±–∏–∫¬ª –¥–ª—è –ø–∏—Å—å–º–∞
  function getCartHtml() {
    if(cart.length === 0) return "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞";

    return cart.map(item=>{
      if(item.type==='chain'){
        return `${item.name} ${item.length} –º–º ${item.width} –º–º ${item.qty} —à—Ç`;
      } else {
        return `${item.name} ${item.qty} —à—Ç`;
      }
    }).join("\n");
  }

  document.getElementById("order-form").addEventListener("submit", function(e){
    e.preventDefault();
    if(cart.length===0){ alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!"); return; }

    const name = document.getElementById("name").value;
    const phone = document.getElementById("phone").value;
    const email = document.getElementById("email").value;

    emailjs.send(SERVICE_ID, TEMPLATE_ID, {
      user_name: name,
      user_email: email,
      user_phone: phone,
      cart_items: getCartHtml()
    })
    .then(()=>{
      alert("–í–∞—à –∑–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! ‚úÖ");
      localStorage.removeItem("cart");
      window.location.reload();
    })
    .catch(err=>{
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞ ‚ùå " + JSON.stringify(err));
    });
  });

  // üî• –û—á–∏—Å—Ç–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
  document.getElementById("clear-cart").addEventListener("click", ()=>{
    if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –ø–æ–ª–Ω–æ—Å—Ç—å—é?")){
      cart = [];
      saveCart();
      renderCart();
    }
  });

  renderCart();
</script>
</body>
</html>
